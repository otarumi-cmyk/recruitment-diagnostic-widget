# CTAクリック率計測プラグイン 要件定義書

## 1. プロジェクト概要

### 1.1 目的
記事内CTA（Call To Action）のクリック率を計測し、記事の表示回数とCTAのクリック数を記録することで、CTR（Click Through Rate）を自動計算するWordPressプラグインを開発する。

### 1.2 背景
- 記事内のCTAの効果を定量的に測定したい
- どの記事のどのCTAが最も効果的かを分析したい
- デバイス別のCTA効果の違いを把握したい

### 1.3 対象ユーザー
- WordPressサイト運営者
- コンテンツマーケター
- 編集者・ライター

## 2. 機能要件

### 2.1 トラッキング機能

#### 2.1.1 記事表示の記録
- **機能**: 記事ページが表示された際に、その記事内のCTAリンクの表示を自動記録
- **対象**: `data-cta-url` 属性を持つリンク要素
- **記録内容**:
  - 記事URL
  - CTA URL
  - セッションID
  - デバイス種別（デスクトップ/モバイル/タブレット）
  - ユーザーエージェント
  - IPアドレス
  - 記録日時

#### 2.1.2 CTAクリックの記録
- **機能**: ユーザーがCTAリンクをクリックした際に、クリックを自動記録
- **記録内容**: 記事表示と同様の情報
- **重複防止**: 同一セッション内で5分以内の重複クリックは記録しない

#### 2.1.3 重複記録の防止
- **ルール**: 同じセッションID、同じ記事URL、同じCTA URL、同じイベントタイプ（表示/クリック）が5分以内に複数回発生した場合、最初の1回のみ記録
- **目的**: ページリロードや誤操作による重複記録を防止

### 2.2 統計表示機能

#### 2.2.1 ダッシュボード
- **サマリー表示**:
  - 総表示数
  - 総クリック数
  - 全体CTR（%）
- **期間選択**:
  - 今日
  - 過去7日間
  - 過去30日間
  - カスタム期間（開始日・終了日指定）

#### 2.2.2 記事別統計
- **表示項目**:
  - 記事URL
  - CTA URL
  - 表示数
  - クリック数
  - CTR（%）
- **ソート**: クリック数降順、CTR降順

#### 2.2.3 CTA別統計
- **表示項目**:
  - CTA URL
  - 表示数
  - クリック数
  - CTR（%）
- **目的**: 各CTAの全体的なパフォーマンスを把握

#### 2.2.4 デバイス別統計
- **表示項目**:
  - デバイス種別（デスクトップ/モバイル/タブレット）
  - 表示数
  - クリック数
  - CTR（%）
- **目的**: デバイスごとのCTA効果の違いを分析

### 2.3 データエクスポート機能

#### 2.3.1 CSVエクスポート
- **機能**: 統計データをCSV形式でダウンロード
- **出力項目**:
  - 記事URL
  - CTA URL
  - 表示数
  - クリック数
  - CTR（%）
- **文字コード**: UTF-8（BOM付き）
- **期間**: 選択した期間のデータをエクスポート

### 2.4 管理機能

#### 2.4.1 ログリセット
- **機能**: すべての記録データを削除
- **権限**: 管理者のみ
- **確認**: 実行前に確認ダイアログを表示（実装予定）

## 3. 非機能要件

### 3.1 パフォーマンス
- **データベースクエリ**: 集計クエリは適切なインデックスを使用し、レスポンス時間を短縮
- **フロントエンド**: トラッキングスクリプトは非同期で実行し、ページ読み込み速度に影響を与えない
- **API応答**: トラッキングAPIの応答は非同期で処理し、ユーザー体験に影響を与えない

### 3.2 セキュリティ
- **入力値検証**: すべての入力値をサニタイズ
- **SQLインジェクション対策**: プリペアドステートメントを使用
- **XSS対策**: 出力値をエスケープ
- **権限管理**: 管理機能は管理者権限のみアクセス可能

### 3.3 互換性
- **WordPressバージョン**: 5.0以上
- **PHPバージョン**: 7.4以上
- **ブラウザ**: モダンブラウザ（Chrome, Firefox, Safari, Edge）

### 3.4 データ保持
- **データベース**: WordPressの標準データベースを使用
- **テーブル名**: `wp_cta_tracker_logs`（プレフィックスはWordPress設定に従う）
- **データ削除**: プラグイン削除時はテーブルを残す（手動削除が必要）

### 3.5 ユーザビリティ
- **管理画面**: WordPress標準のUIデザインに準拠
- **レスポンシブ**: 管理画面はモバイルデバイスでも利用可能
- **操作性**: 直感的で分かりやすいインターフェース

## 4. 技術仕様

### 4.1 アーキテクチャ

#### 4.1.1 ファイル構成
```
cta-click-tracker-plugin/
├── cta-click-tracker.php          # メインプラグインファイル
├── includes/
│   ├── class-database.php         # データベース操作クラス
│   ├── class-frontend.php         # フロントエンドクラス
│   ├── class-admin.php            # 管理画面クラス
│   └── views/
│       └── dashboard.php          # ダッシュボードビュー
├── assets/
│   ├── js/
│   │   ├── tracker.js             # フロントエンドトラッキングスクリプト
│   │   └── admin.js               # 管理画面JavaScript
│   └── css/
│       └── admin.css              # 管理画面CSS
└── README.md                       # ドキュメント
```

#### 4.1.2 データベース設計

**テーブル: wp_cta_tracker_logs**

| カラム名 | 型 | 説明 | インデックス |
|---------|-----|------|------------|
| id | bigint(20) | 主キー | PRIMARY KEY |
| article_url | varchar(500) | 記事URL | INDEX |
| cta_url | varchar(500) | CTA URL | INDEX |
| event_type | varchar(20) | イベントタイプ（impression/click） | INDEX |
| device | varchar(20) | デバイス種別 | INDEX |
| session_id | varchar(64) | セッションID | INDEX |
| user_agent | text | ユーザーエージェント | - |
| ip_address | varchar(45) | IPアドレス | - |
| created_at | datetime | 記録日時 | INDEX |

### 4.2 API仕様

#### 4.2.1 トラッキングAPI
- **エンドポイント**: `admin-ajax.php`
- **アクション**: `cta_tracker_log`
- **メソッド**: POST
- **パラメータ**:
  - `event_type`: impression または click
  - `article_url`: 記事URL
  - `cta_url`: CTA URL
  - `session_id`: セッションID
  - `device`: desktop, mobile, tablet
  - `nonce`: セキュリティnonce（オプション）

#### 4.2.2 統計取得API
- **エンドポイント**: 管理画面内（PHP直接実行）
- **機能**: データベースから直接集計データを取得

### 4.3 フロントエンド仕様

#### 4.3.1 トラッキングスクリプト
- **自動検出**: `data-cta-url` 属性を持つリンクを自動検出
- **初期化**: DOMContentLoadedイベントで自動実行
- **非同期処理**: fetch APIを使用した非同期通信
- **エラーハンドリング**: エラーが発生してもページ動作に影響しない

#### 4.3.2 セッション管理
- **保存場所**: localStorage
- **キー名**: `cta_tracker_session_id`
- **有効期限**: ブラウザを閉じるまで（手動削除まで）

#### 4.3.3 デバイス判定
- **判定方法**: User Agent文字列の解析
- **判定結果**: desktop, mobile, tablet

## 5. 使用方法

### 5.1 インストール
1. `cta-click-tracker-plugin.zip` を解凍
2. `cta-click-tracker-plugin` フォルダを `wp-content/plugins/` にアップロード
3. WordPress管理画面の「プラグイン」から有効化

### 5.2 記事への実装
記事内のCTAリンクに `data-cta-url` 属性を追加：

```html
<a href="https://example.com/landing-page" data-cta-url="https://example.com/landing-page">
    今すぐ登録する
</a>
```

### 5.3 統計の確認
WordPress管理画面の「CTA計測」メニューから各種統計を確認

## 6. 制約事項

### 6.1 技術的制約
- 同一セッション内の5分以内の重複は記録しない
- セッションIDはlocalStorageに依存（プライベートモードでは制限あり）
- JavaScriptが無効な環境では動作しない

### 6.2 データ制約
- URLの最大長: 500文字
- セッションIDの最大長: 64文字
- データベースの容量制限に依存

## 7. 今後の拡張予定

### 7.1 機能拡張
- リアルタイム統計表示
- グラフ・チャート表示
- メールレポート機能
- A/Bテスト機能
- カスタムイベントの記録

### 7.2 改善予定
- ログリセット時の確認ダイアログ
- データの自動削除機能（古いログの自動削除）
- エクスポート形式の追加（JSON, Excel等）
- API認証の強化

## 8. テスト項目

### 8.1 機能テスト
- [ ] 記事表示の記録が正常に動作する
- [ ] CTAクリックの記録が正常に動作する
- [ ] 重複記録が防止される
- [ ] 統計データが正しく表示される
- [ ] CSVエクスポートが正常に動作する
- [ ] 期間選択が正常に動作する

### 8.2 パフォーマンステスト
- [ ] 大量データでの統計表示が正常に動作する
- [ ] トラッキングスクリプトがページ読み込み速度に影響しない

### 8.3 セキュリティテスト
- [ ] SQLインジェクション対策が機能している
- [ ] XSS対策が機能している
- [ ] 権限管理が正常に動作する

## 9. バージョン情報

- **バージョン**: 1.0.0
- **リリース日**: 2025年1月
- **WordPress要件**: 5.0以上
- **PHP要件**: 7.4以上

## 10. 変更履歴

### Version 1.0.0 (2025-01)
- 初回リリース
- 基本的なトラッキング機能
- 統計表示機能
- CSVエクスポート機能
